<script type="text/javascript">
var timer;
var ctrl = false;

document.onkeydown = tofilter;
document.onkeyup = resetctrl;

function resetctrl(e)
{
    var KeyID = (window.event) ? event.keyCode : e.keyCode;
    if (KeyID == 17) {
        ctrl = false;
    }
}

function tofilter(e) {
    var KeyID = (window.event) ? event.keyCode : e.keyCode;
    if (KeyID == 17) {
        ctrl = true;
        return;
    }
    switch(KeyID)
    {
        case 59:
        case 186:
        case 190:
        case 191:
            if (ctrl) {
                toggle_menu()
                var e = document.getElementById('addfilter')
                if (e) {
                    e.focus();
                }
            }
            break;
    }
}

function toggle_menu()
{
    var menubar = document.getElementById("menubar");
    var status = document.getElementById("filterbar_status");
    if (menubar.className=="menubar") {
        menubar.className="menubar_shown";
        if (status) {
            status.value = 'shown';
        }
    } else {
        menubar.className="menubar";
        if (status) {
            status.value = 'hidden';
        }
    }
}

// Set the default "show" mode to that specified by W3C DOM
// compliant browsers

var showMode = 'table-cell';

// However, IE5 at least does not render table cells correctly
// using the style 'table-cell', but does when the style 'block'
// is used, so handle this

if (document.all) showMode='block';

// This is the function that actually does the manipulation

function toggleVis(btn){

	// First isolate the checkbox by name using the
	// name of the form and the name of the checkbox

	btn = document.getElementsByName(btn)[0];

	// Next find all the table cells by using the DOM function
	// getElementsByName passing in the constructed name of
	// the cells, derived from the checkbox name

	cells = document.getElementsByName('t'+btn.name);

	// Once the cells and checkbox object has been retrieved
	// the show hide choice is simply whether the checkbox is
	// checked or clear

	mode = btn.checked ? showMode : 'none';

	// Apply the style to the CSS display property for the cells

	for(j = 0; j < cells.length; j++) {
		cells[j].style.display = mode;
        }
}

</script>

{{
def DB_FILTERS_ACTIVE(filters):
    if filters is None or len(filters) == 0:
        return T("None")
    i1 = INPUT(_type='hidden', _name='delfilter')
    i2 = INPUT(_type='hidden', _name='togfilter')
    lines = []
    for f in filters:
        if f.auth_filters.fil_value is not None and \
           len(f.auth_filters.fil_value) != 0:
            value = " [%s]"%f.auth_filters.fil_value
        else:
            value = ""
        pass
        if f.auth_filters.fil_active:
            img = "checked16.png"
        else:
            img = "unchecked16.png"
        pass
        lines += [TR(
                    TD(T(f.filters.fil_name),
                       value,
                       _style="""background-image:url(%s);
                                 background-repeat:no-repeat;
                                 background-position:center left;
                                 padding:0px;
                                 padding-right:4px;
                                 padding-left:18px;
                              """%URL(r=request,c='static',f=f.filters.fil_img),
                    ),
                    TD(IMG(_src=URL(r=request,c='static',f=img),
                           _border=0,
                           _title=T("enable/disable filter"),
                           _onClick='javascript:document.svcform.togfilter.value='+str(f.auth_filters.id)+';document.svcform.submit()'
                       ),
                    ),
                    TD(IMG(_src=URL(r=request,c='static',f='del.png'),
                           _border=0,
                           _title=T("remove filter"),
                           _onClick='javascript:document.svcform.delfilter.value='+str(f.auth_filters.id)+';document.svcform.submit()'
                       ),
                       _style='padding:0px;',
                    ),
                  )]
    pass
    return DIV(i1, i2, TABLE(lines))
pass

def DB_FILTERS_AVAIL(filters):
    if filters is None or len(filters) == 0:
        return DIV()
    options = [OPTION(T('choose'), _value='')]
    for f in filters:
        if f.fil_need_value == 1:
            title = 'need value'
        else:
            title = ''
        pass
        options += [OPTION(T(f.fil_name),
                           _style='background-image:url(%s);background-repeat:no-repeat;padding-left:18px;'%URL(r=request,c='static',f=f.fil_img),
                           _value=f.id,
                           _id='addfilter_opt'+str(f.id),
                           _title=title,
                    )]
    pass
    t = TABLE(
          TR(
            TD(
              SELECT(options,
                     _name='addfilter',
                     _id='addfilter',
                     _onChange="""javascript:toggle_filter_value_input();
                                  ajax("%(url)s",['filtervalue', 'addfilter'],"cloud");
                                  getElementById("cloud").className="cloud_shown";
                               """%dict(url=URL(r=request,f='ajax_filter_cloud')),
              ),
            ),
            TD(
              IMG(_src=URL(r=request,c='static',f='add.png'),
                  _border=0,
                  _title=T("add filter"),
                  _onClick='javascript:document.svcform.submit()',
              ),
            ),
          ),
          TR(
            TD(
              INPUT(_name='filtervalue',
                    _id='filtervalue',
                    _onKeyPress='javascript:checkEnter(event);',
                    _onKeyUp="""
                       clearTimeout(timer);
                       timer=setTimeout(function validate(){ajax('%(url)s', ['filtervalue', 'addfilter'], 'cloud')}, 800);
                    """%dict(url=URL(r=request,f='ajax_filter_cloud')),
                    _style='width:18em',
              ),
              _colspan=2,
            ),
            _class='hidden',
            _id='tr_filtervalue',
          ),
        )
    return DIV(t)
pass

def COLUMNS_ACTIVE():
    if 'colkeys' not in globals():
        return DIV()
    def checkbox(a):
        if columns[a]['display'] or \
           ('col_'+a in request.vars and request.vars['col_'+a] == 'on'):
            val = 'on'
        else:
            val = ''
        pass
        return SPAN(
                 INPUT(
                   _type='checkbox',
                   _name='col_'+a,
                   _onclick="""toggleVis(this.name);
                               getElementById("set_col_table").value="%(table)s";
                               getElementById("set_col_field").value="%(field)s";
                               getElementById("set_col_value").value=this.checked;
                               ajax("%(url)s",["set_col_table", "set_col_field", "set_col_value"],"set_col_dummy");
                            """%dict(url=URL(r=request,f='ajax_set_user_prefs_column'),
                                   table=request.function, field=a),
                   value=val,
                   _style='vertical-align:text-bottom',
                 ),
                 SPAN(
                   columns[a]['title'],
                   _style="""background-image:url(%s);
                             background-repeat:no-repeat;
                             padding-left:18px;
                             margin-left:0.2em;
                          """%URL(r=request,c='static',f=columns[a]['img']+'.png'),
                 ),
                 BR(),
               )
    a = DIV(
          map(checkbox, colkeys),
          _style='-moz-column-width:13em;-webkit-column-width:13em;column-width:13em',
        )
    return a
pass

def COLUMNS_ACTIVE_TITLE():
    if 'colkeys' not in globals():
         return ''
    else:
         return 'Active columns'
pass

def DB_FILTERS_TABLE(active, avail):
    if "filterbar_status" in request.vars and \
       request.vars.filterbar_status == "shown":
        menubar_class = "menubar_shown"
        filterbar_state = "shown"
    else:
        menubar_class = "menubar"
        filterbar_state = "hidden"
    pass

    t = TABLE(
      TR(
        TH(T('Available filters')),
        TH(T('Active filters')),
        TH(T(COLUMNS_ACTIVE_TITLE()), _width='60%'),
      ),
      TR(
        TD(DB_FILTERS_AVAIL(available_filters)),
        TD(DB_FILTERS_ACTIVE(active_filters)),
        TD(COLUMNS_ACTIVE()),
      ),
    )
    c = DIV(_id='cloud')
    filterbar = DIV(
      t,
      c,
      SPAN(
        _id='set_col_dummy',
        _style='display:none',
      ),
      INPUT(
        _name='set_col_field',
        _id='set_col_field',
        _type='hidden',
      ),
      INPUT(
        _name='set_col_table',
        _id='set_col_table',
        _type='hidden',
      ),
      INPUT(
        _name='set_col_value',
        _id='set_col_value',
        _type='hidden',
      ),
      INPUT(
        _name='filterbar_status',
        _id='filterbar_status',
        _type='hidden',
        _value=filterbar_state
      ),
      _class=menubar_class,
      _id='menubar',
    )
    handlebar = DIV(
      'filters',
      _class='menuhandle',
      _onclick='toggle_menu()',
    )
    return SPAN(filterbar, handlebar)
pass

def col_hide(key):
    if columns[key]['display'] or \
       ('col_'+key in request.vars and request.vars['col_'+key] == 'on'):
         return ""
    else:
         return "display:none"
pass

def initialize_keys():
    for key in colkeys:
        if not request.vars.has_key(key) or \
           request.vars[key] is None:
            request.vars[key]=''
        pass
    pass
pass

}}
