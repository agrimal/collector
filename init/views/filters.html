<script type="text/javascript">
var timer;
var lastkeypress = 0;

document.onkeydown = tofilter;
document.onkeyup = reset_lastkeypress;

function reset_lastkeypress() {
    lastkeypress = 0;
}

function toggle_menu()
{
    var menubar = document.getElementById("menubar");
    if (menubar.className=="menubar") {
        menubar.className="menubar_shown";
    } else {
        menubar.className="menubar";
    }
}

function tofilter(e) {
    var KeyID = (window.event) ? event.keyCode : e.keyCode;
    //alert(event.keyCode);
    //alert(KeyID);
    switch(KeyID)
    {
        case 59:
        case 190:
        case 191:
            if (lastkeypress == 17) {
                // Ctrl + :
                toggle_menu()
                document.svcform.addfilter.focus();
                //document.svcform.addfilter.select();
            }
            break;
    }
    lastkeypress = KeyID;
}

</script>

{{
def DB_FILTERS_ACTIVE(filters):
    if filters is None or len(filters) == 0:
        return T("None")
    i = INPUT(_type='hidden', _name='delfilter')
    lines = []
    for f in filters:
        if f.auth_filters.fil_value is not None and \
           len(f.auth_filters.fil_value) != 0:
            value = " [%s]"%f.auth_filters.fil_value
        else:
            value = ""
        pass
        lines += [TR(
                    TD(T(f.filters.fil_name),
                       value,
                       _style='background-image:url(%s);
                               background-repeat:no-repeat;
                               background-position:center left;
                               padding:0px;
                               padding-right:4px;
                               padding-left:18px;
                              '%URL(r=request,c='static',f=f.filters.fil_img),
                    ),
                    TD(IMG(_src=URL(r=request,c='static',f='del.png'),
                           _border=0,
                           _title=T("remove filter"),
                           _onClick='javascript:document.svcform.delfilter.value='+str(f.auth_filters.id)+';document.svcform.submit()'
                       ),
                       _style='padding:0px;',
                    ),
                  )]
    pass
    return DIV(i, TABLE(lines))
pass

def DB_FILTERS_AVAIL(filters):
    if filters is None or len(filters) == 0:
        return DIV()
    options = [OPTION(T('choose'), _value='')]
    for f in filters:
        if f.fil_need_value == 1:
            title = 'need value'
        else:
            title = ''
        pass
        options += [OPTION(T(f.fil_name),
                           _style='background-image:url(%s);background-repeat:no-repeat;padding-left:18px;'%URL(r=request,c='static',f=f.fil_img),
                           _value=f.id,
                           _id='addfilter_opt'+str(f.id),
                           _title=title,
                    )]
    pass
    t = TABLE(
          TR(
            TD(
              SELECT(options,
                     _name='addfilter',
                     _id='addfilter',
                     _onChange="""javascript:toggle_filter_value_input();
                                  ajax("%(url)s",['filtervalue', 'addfilter'],"cloud");
                                  getElementById("cloud").className="cloud_shown";
                               """%dict(url=URL(r=request,f='ajax_filter_cloud')),
              ),
            ),
            TD(
              IMG(_src=URL(r=request,c='static',f='add.png'),
                  _border=0,
                  _title=T("add filter"),
                  _onClick='javascript:document.svcform.submit()',
              ),
            ),
          ),
          TR(
            TD(
              INPUT(_name='filtervalue',
                    _id='filtervalue',
                    _onKeyPress='javascript:checkEnter(event);',
                    _onKeyUp="""
                       clearTimeout(timer);
                       timer=setTimeout(function validate(){ajax('%(url)s', ['filtervalue', 'addfilter'], 'cloud')}, 800);
                    """%dict(url=URL(r=request,f='ajax_filter_cloud')),
                    _style='width:18em',
              ),
              _colspan=2,
            ),
            _class='hidden',
            _id='tr_filtervalue',
          ),
        )
    return DIV(t)
pass

def DB_FILTERS_TABLE(active, avail):
    t = TABLE(
      TR(
        TD(T('Available filters')),
        TD(T('Active filters')),
      ),
      TR(
        TD(DB_FILTERS_AVAIL(available_filters)),
        TD(DB_FILTERS_ACTIVE(active_filters)),
      ),
    )
    c = DIV(_id='cloud')
    filterbar = DIV(
      t,
      c,
      _class='menubar',
      _id='menubar',
    )
    handlebar = DIV(
      'filters',
      _class='menuhandle',
      _onclick='toggle_menu()',
    )
    return SPAN(filterbar, handlebar)
pass

}}
