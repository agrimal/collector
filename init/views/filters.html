<script type="text/javascript">
var timer;
var lastkeypress = 0;

document.onkeydown = tofilter;
document.onkeyup = reset_lastkeypress;

function reset_lastkeypress() {
    lastkeypress = 0;
}

function toggle_menu()
{
    var menubar = document.getElementById("menubar");
    if (menubar.className=="menubar") {
        menubar.className="menubar_shown";
    } else {
        menubar.className="menubar";
    }
}

function tofilter(e) {
    var KeyID = (window.event) ? event.keyCode : e.keyCode;
    //alert(event.keyCode);
    //alert(KeyID);
    switch(KeyID)
    {
        case 59:
        case 190:
        case 191:
            if (lastkeypress == 17) {
                // Ctrl + :
                toggle_menu()
                document.svcform.addfilter.focus();
                //document.svcform.addfilter.select();
            }
            break;
    }
    lastkeypress = KeyID;
}

// Set the default "show" mode to that specified by W3C DOM
// compliant browsers

var showMode = 'table-cell';

// However, IE5 at least does not render table cells correctly
// using the style 'table-cell', but does when the style 'block'
// is used, so handle this

if (document.all) showMode='block';

// This is the function that actually does the manipulation

function toggleVis(btn){

	// First isolate the checkbox by name using the
	// name of the form and the name of the checkbox

	btn = document.getElementsByName(btn)[0];

	// Next find all the table cells by using the DOM function
	// getElementsByName passing in the constructed name of
	// the cells, derived from the checkbox name

	cells = document.getElementsByName('t'+btn.name);

	// Once the cells and checkbox object has been retrieved
	// the show hide choice is simply whether the checkbox is
	// checked or clear

	mode = btn.checked ? showMode : 'none';

	// Apply the style to the CSS display property for the cells

	for(j = 0; j < cells.length; j++) {
		cells[j].style.display = mode;
        }
}

</script>

{{
def DB_FILTERS_ACTIVE(filters):
    if filters is None or len(filters) == 0:
        return T("None")
    i = INPUT(_type='hidden', _name='delfilter')
    lines = []
    for f in filters:
        if f.auth_filters.fil_value is not None and \
           len(f.auth_filters.fil_value) != 0:
            value = " [%s]"%f.auth_filters.fil_value
        else:
            value = ""
        pass
        lines += [TR(
                    TD(T(f.filters.fil_name),
                       value,
                       _style='background-image:url(%s);
                               background-repeat:no-repeat;
                               background-position:center left;
                               padding:0px;
                               padding-right:4px;
                               padding-left:18px;
                              '%URL(r=request,c='static',f=f.filters.fil_img),
                    ),
                    TD(IMG(_src=URL(r=request,c='static',f='del.png'),
                           _border=0,
                           _title=T("remove filter"),
                           _onClick='javascript:document.svcform.delfilter.value='+str(f.auth_filters.id)+';document.svcform.submit()'
                       ),
                       _style='padding:0px;',
                    ),
                  )]
    pass
    return DIV(i, TABLE(lines))
pass

def DB_FILTERS_AVAIL(filters):
    if filters is None or len(filters) == 0:
        return DIV()
    options = [OPTION(T('choose'), _value='')]
    for f in filters:
        if f.fil_need_value == 1:
            title = 'need value'
        else:
            title = ''
        pass
        options += [OPTION(T(f.fil_name),
                           _style='background-image:url(%s);background-repeat:no-repeat;padding-left:18px;'%URL(r=request,c='static',f=f.fil_img),
                           _value=f.id,
                           _id='addfilter_opt'+str(f.id),
                           _title=title,
                    )]
    pass
    t = TABLE(
          TR(
            TD(
              SELECT(options,
                     _name='addfilter',
                     _id='addfilter',
                     _onChange="""javascript:toggle_filter_value_input();
                                  ajax("%(url)s",['filtervalue', 'addfilter'],"cloud");
                                  getElementById("cloud").className="cloud_shown";
                               """%dict(url=URL(r=request,f='ajax_filter_cloud')),
              ),
            ),
            TD(
              IMG(_src=URL(r=request,c='static',f='add.png'),
                  _border=0,
                  _title=T("add filter"),
                  _onClick='javascript:document.svcform.submit()',
              ),
            ),
          ),
          TR(
            TD(
              INPUT(_name='filtervalue',
                    _id='filtervalue',
                    _onKeyPress='javascript:checkEnter(event);',
                    _onKeyUp="""
                       clearTimeout(timer);
                       timer=setTimeout(function validate(){ajax('%(url)s', ['filtervalue', 'addfilter'], 'cloud')}, 800);
                    """%dict(url=URL(r=request,f='ajax_filter_cloud')),
                    _style='width:18em',
              ),
              _colspan=2,
            ),
            _class='hidden',
            _id='tr_filtervalue',
          ),
        )
    return DIV(t)
pass

def COLUMNS_ACTIVE():
    if 'colkeys' not in globals():
        return DIV()
    def checkbox(a):
        if columns[a]['display'] or \
           ('col_'+a in request.vars and request.vars['col_'+a] == 'on'):
            val = 'on'
        else:
            val = ''
        pass
        return SPAN(
                 INPUT(
                   _type='checkbox',
                   _name='col_'+a,
                   _onclick='toggleVis(this.name)',
                   value=val,
                 ),
                 columns[a]['title'],
                 BR(),
               )
    a = DIV(
          map(checkbox, colkeys),
          _style='-moz-column-width:13em;-webkit-column-width:13em',
        )
    return a
pass

def COLUMNS_ACTIVE_TITLE():
    if 'colkeys' not in globals():
         return ''
    else:
         return 'Active columns'
pass

def DB_FILTERS_TABLE(active, avail):
    t = TABLE(
      TR(
        TH(T('Available filters')),
        TH(T('Active filters')),
        TH(T(COLUMNS_ACTIVE_TITLE()), _width='60%'),
      ),
      TR(
        TD(DB_FILTERS_AVAIL(available_filters)),
        TD(DB_FILTERS_ACTIVE(active_filters)),
        TD(COLUMNS_ACTIVE()),
      ),
    )
    c = DIV(_id='cloud')
    filterbar = DIV(
      t,
      c,
      _class='menubar',
      _id='menubar',
    )
    handlebar = DIV(
      'filters',
      _class='menuhandle',
      _onclick='toggle_menu()',
    )
    return SPAN(filterbar, handlebar)
pass

def col_hide(key):
    if columns[key]['display'] or \
       ('col_'+key in request.vars and request.vars['col_'+key] == 'on'):
         return ""
    else:
         return "display:none"
pass

def initialize_keys():
    for key in colkeys:
        if not request.vars.has_key(key) or \
           request.vars[key] is None:
            request.vars[key]=''
        pass
    pass
pass

}}
