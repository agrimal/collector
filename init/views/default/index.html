{{extend 'layout.html'}}
{{include 'box.html'}}
{{include '../static/jslib.html'}}
{{include 'filters.html'}}
{{
def svc_status(svc, cellclass="cell2", nestedin=None):
    cl = {}
    for k in ['mon_overallstatus',
              'mon_containerstatus',
              'mon_ipstatus',
              'mon_fsstatus',
              'mon_diskstatus',
              'mon_syncstatus',
              'mon_appstatus']:
        if nestedin is None:
            if svc[k] is None:
                cl[k] = 'status_undef'
            else:
                cl[k] = 'status_'+svc[k].replace(" ", "_")
            pass
        else:
            if svc[nestedin][k] is None:
                cl[k] = 'status_undef'
            else:
                cl[k] = 'status_'+svc[nestedin][k].replace(" ", "_")
            pass
        pass
    pass

    if nestedin is None:
        overallstatus = svc.mon_overallstatus
    else:
        overallstatus = svc[nestedin].mon_overallstatus
    pass

    t = TABLE(
      TR(
        TD(overallstatus,
           _colspan=6, 
           _class=cellclass+' status '+cl['mon_overallstatus'],
        ),
      ),
      TR(
        TD("vm", _class=cellclass+' '+cl['mon_containerstatus']),
        TD("ip", _class=cellclass+' '+cl['mon_ipstatus']),
        TD("fs", _class=cellclass+' '+cl['mon_fsstatus']),
        TD("dg", _class=cellclass+' '+cl['mon_diskstatus']),
        TD("sync", _class=cellclass+' '+cl['mon_syncstatus']),
        TD("app", _class=cellclass+' '+cl['mon_appstatus']),
      ),
    )
    return t
    pass


""" Last status changes
"""
def last_changes_line(line, cellclass):
    tr = TR(
      TD(A(line.svcmon_log.mon_begin, _href=URL(r=request, f='svcmon_log', vars={'mon_svcname':line.svcmon_log.mon_svcname})), _class=cellclass),
      TD(A(line.svcmon_log.mon_svcname, _href=URL(r=request, f='svcmon', vars={'svcname':line.svcmon_log.mon_svcname})), _class=cellclass),
      TD(A(line.svcmon_log.mon_nodname, _href=URL(r=request, f='svcmon', vars={'nodename':line.svcmon_log.mon_nodname})), _class=cellclass),
      TD(svc_status(line, cellclass, nestedin='svcmon_log'), _class=cellclass),
    )
    return tr
    pass

def last_changes_header():
    tr = TR(
      TH(T("Date")),
      TH(T("Service")),
      TH(T("Node")),
      TH(T("Status"), _style="text-align:center"),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def last_changes_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in lastchanges:
        cellclass = cellclasses[cellclass]
        lines += [last_changes_line(line, cellclass)]
        pass

    t = TABLE(
        last_changes_header(),
        lines,
    )
    return t
    pass

def last_changes():
    if len(lastchanges) == 0:
        return DIV()
    d = DIV(
      H2(T("Last service status changes"), _style="padding:10px"),
      last_changes_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Services with unacknowleged errors
"""
def svc_with_errors_line(line, cellclass):
    tr = TR(
      TD(A(line.svc_name, _href=URL(r=request, f='svcmon', vars={'svcname':line.svc_name})), _class=cellclass),
      TD(A(line.mon_nodname, _href=URL(r=request, f='svcmon', vars={'nodename':line.mon_nodname})), _class=cellclass),
      TD(line.svc_type, _class=cellclass),
      TD(A(line.err, _href=URL(r=request,f='svcactions', vars={'svcname': line.svc_name, 'status': 'err', 'ack': '!1|empty'})), _class=cellclass),
      TD(svc_status(line, cellclass), _class=cellclass),
    )
    return tr
    pass

def svc_with_errors_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Node")),
      TH(T("Env")),
      TH(T("Error count")),
      TH(T("Status"), _style="text-align:center"),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def svc_with_errors_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcwitherrors:
        cellclass = cellclasses[cellclass]
        lines += [svc_with_errors_line(line, cellclass)]
        pass

    t = TABLE(
        svc_with_errors_header(),
        lines,
    )
    return t
    pass

def svc_with_errors():
    if len(svcwitherrors) == 0:
        return DIV()
    d = DIV(
      H2(T("Services with errors"), _style="padding:10px"),
      svc_with_errors_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Services not up on all nodes
"""
def svc_not_up_line(line, cellclass):
    tr = TR(
      TD(A(line.v_svc_group_status.svcname, _href=URL(r=request, f='svcmon', vars={'svcname':line.v_svc_group_status.svcname})), _class=cellclass),
      TD(line.v_svc_group_status.svctype, _class=cellclass),
      TD(line.v_svc_group_status.groupstatus, _class=cellclass),
    )
    return tr
    pass

def svc_not_up_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Env")),
      TH(T("Cluster status")),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def svc_not_up_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcnotup:
        cellclass = cellclasses[cellclass]
        lines += [svc_not_up_line(line, cellclass)]
        pass

    t = TABLE(
        svc_not_up_header(),
        lines,
    )
    return t
    pass

def svc_not_up():
    if len(svcnotup) == 0:
        return DIV()
    d = DIV(
      H2(T("Services not up"), _style="padding:10px"),
      svc_not_up_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Services not up on their primary node
"""
def svc_not_on_primary_line(line, cellclass):
    tr = TR(
      TD(A(line.svc_name, _href=URL(r=request, f='svcmon', vars={'svcname':line.svc_name})), _class=cellclass),
      TD(A(line.svc_autostart, _href=URL(r=request, f='svcmon', vars={'nodename':line.svc_autostart})), _class=cellclass),
      TD(line.svc_type, _class=cellclass),
      TD(svc_status(line, cellclass), _class=cellclass),
    )
    return tr
    pass

def svc_not_on_primary_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Primary")),
      TH(T("Env")),
      TH(T("Status on primary"), _style="text-align:center"),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def svc_not_on_primary_table(svcnotonprimary):
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcnotonprimary:
        cellclass = cellclasses[cellclass]
        lines += [svc_not_on_primary_line(line, cellclass)]
        pass

    t = TABLE(
        svc_not_on_primary_header(),
        lines,
    )
    return t
    pass

def svc_not_on_primary():
    svcnotup_names = [s.v_svc_group_status.svcname for s in svcnotup]
    list = [s for s in svcnotonprimary if s.svc_name not in svcnotup_names]
    if len(list) == 0:
        return DIV()
    d = DIV(
      H2(T("Services not up on primary"), _style="padding:10px"),
      svc_not_on_primary_table(list),
      _style="padding:10px",
    )
    return d
    pass


""" Applications without responsibles
"""
def app_wo_resp_line(line, cellclass):
    tr = TR(
      TD(line.app, _class=cellclass),
    )
    return tr
    pass

def app_wo_resp_header():
    tr = TR(
      TH(T("App")),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def app_wo_resp_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in appwithoutresp:
        cellclass = cellclasses[cellclass]
        lines += [app_wo_resp_line(line, cellclass)]
        pass

    t = TABLE(
        app_wo_resp_header(),
        lines,
    )
    return t
    pass

def app_wo_resp():
    if len(appwithoutresp) == 0:
        return DIV()
    d = DIV(
      H2(T("Application without responsibles"), _style="padding:10px"),
      app_wo_resp_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Systems obsolescent (alert)
"""
def obs_os_alert_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'nodename':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_alert_date, _class=cellclass),
    )
    return tr
    pass

def obs_os_alert_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Operating system")),
      TH(T("Alert since")),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def obs_os_alert_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obsosalert:
        cellclass = cellclasses[cellclass]
        lines += [obs_os_alert_line(line, cellclass)]
        pass

    t = TABLE(
        obs_os_alert_header(),
        lines,
    )
    return t
    pass

def obs_os_alert():
    if len(obsosalert) == 0:
        return DIV()
    d = DIV(
      H2(T("Nodes with obsolescent operating system (alert)"), _style="padding:10px"),
      obs_os_alert_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Systems obsolescent (warning)
"""
def obs_os_warn_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'nodename':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_warn_date, _class=cellclass),
    )
    return tr
    pass

def obs_os_warn_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Operating system")),
      TH(T("Warning since")),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def obs_os_warn_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obsoswarn:
        cellclass = cellclasses[cellclass]
        lines += [obs_os_warn_line(line, cellclass)]
        pass

    t = TABLE(
        obs_os_warn_header(),
        lines,
    )
    return t
    pass

def obs_os_warn():
    if len(obsoswarn) == 0:
        return DIV()
    d = DIV(
      H2(T("Nodes with obsolescent operating system (warn)"), _style="padding:10px"),
      obs_os_warn_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Model obsolescent (warning)
"""
def obs_hw_warn_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'nodename':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_warn_date, _class=cellclass),
    )
    return tr
    pass

def obs_hw_warn_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Model")),
      TH(T("Warning since")),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def obs_hw_warn_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obshwwarn:
        cellclass = cellclasses[cellclass]
        lines += [obs_hw_warn_line(line, cellclass)]
        pass

    t = TABLE(
        obs_hw_warn_header(),
        lines,
    )
    return t
    pass

def obs_hw_warn():
    if len(obshwwarn) == 0:
        return DIV()
    d = DIV(
      H2(T("Nodes with obsolescent hardware (warn)"), _style="padding:10px"),
      obs_hw_warn_table(),
      _style="padding:10px",
    )
    return d
    pass


""" Model obsolescent (alert)
"""
def obs_hw_alert_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'nodename':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_alert_date, _class=cellclass),
    )
    return tr
    pass

def obs_hw_alert_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Model")),
      TH(T("Alert since")),
      _style="border-bottom:4px solid darkorange",
    )
    return tr
    pass

def obs_hw_alert_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obshwalert:
        cellclass = cellclasses[cellclass]
        lines += [obs_hw_alert_line(line, cellclass)]
        pass

    t = TABLE(
        obs_hw_alert_header(),
        lines,
    )
    return t
    pass

def obs_hw_alert():
    if len(obshwalert) == 0:
        return DIV()
    d = DIV(
      H2(T("Nodes with obsolescent hardware (alert)"), _style="padding:10px"),
      obs_hw_alert_table(),
      _style="padding:10px",
    )
    return d
    pass

def obs_miss():
    if obswarnmiss + obsalertmiss == 0:
        return DIV()
    return DIV(
      H2(T("Items with missing obsolescence information")),
      TABLE(
        TR(
          TH(T("Date not set")),
          TH(T("Item count")),
          _style="border-bottom:4px solid darkorange",
        ),
        TR(
          TD(T("Warn")),
          TD(A(obswarnmiss, _href=(URL(r=request, f='obsolescence_config', vars={'obs_warn_date': 'empty|0000-00-00 00:00:00'})))),
        ),
        TR(
          TD(T("Alert"), _class="cell1"),
          TD(A(obsalertmiss, _href=(URL(r=request, f='obsolescence_config', vars={'obs_alert_date': 'empty|0000-00-00 00:00:00'}))), _class="cell1"),
        )
      )
    )
    pass

}}

{{=FORM(
     DB_FILTERS_TABLE(active_filters, available_filters),
     _action='index',
     _name='svcform',
     _id='svcform',
   )
}}
{{=DIV(
     last_changes(),
     app_wo_resp(),
     svc_with_errors(),
     svc_not_up(),
     svc_not_on_primary(),
     obs_os_alert(),
     obs_os_warn(),
     obs_hw_alert(),
     obs_hw_warn(),
     obs_miss(),
     _style="
       padding-left:2em;
       padding-right:2em;
       -moz-column-width:30em;
       -moz-column-gap:4em;
       -webkit-column-width:30em;
       -webkit-column-gap:4em;
     "
   )
}}

