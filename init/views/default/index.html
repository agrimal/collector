{{extend 'layout.html'}}
{{include 'box.html'}}
{{include '../static/jslib.html'}}
{{include 'filters.html'}}
{{include 'panel.html'}}
<script>
function ScrollToElement(theElement){

  var selectedPosX = 0;
  var selectedPosY = 0;
              
  while(theElement != null){
    //selectedPosX += theElement.offsetLeft;
    selectedPosY += theElement.offsetTop;
    theElement = theElement.offsetParent;
  }
                        		      
 window.scrollTo(selectedPosX,selectedPosY);
}

</script>
{{

now = datetime.datetime.now()
tmo = now - datetime.timedelta(minutes=15)

def svc_status(svc, cellclass="cell2", nestedin=None):
    cl = {}
    for k in ['mon_overallstatus',
              'mon_containerstatus',
              'mon_ipstatus',
              'mon_fsstatus',
              'mon_diskstatus',
              'mon_syncstatus',
              'mon_appstatus']:
        if nestedin is None:
            if svc[k] is None:
                cl[k] = 'status_undef'
            elif 'mon_updated' in svc and svc['mon_updated'] < tmo:
                cl[k] = 'status_expired'
            else:
                cl[k] = 'status_'+svc[k].replace(" ", "_")
            pass
        else:
            if svc[nestedin][k] is None:
                cl[k] = 'status_undef'
            elif 'mon_updated' in svc[nestedin] and svc[nestedin]['mon_updated'] < tmo:
                cl[k] = 'status_expired'
            else:
                cl[k] = 'status_'+svc[nestedin][k].replace(" ", "_")
            pass
        pass
    pass

    if nestedin is None:
        overallstatus = svc.mon_overallstatus
    else:
        overallstatus = svc[nestedin].mon_overallstatus
    pass

    t = DIV(
          TABLE(
            TR(
              TD(overallstatus,
                 _colspan=6, 
                 _class=cellclass+' status '+cl['mon_overallstatus'],
              ),
            ),
            TR(
              TD("vm", _class=cellclass+' '+cl['mon_containerstatus']),
              TD("ip", _class=cellclass+' '+cl['mon_ipstatus']),
              TD("fs", _class=cellclass+' '+cl['mon_fsstatus']),
              TD("dg", _class=cellclass+' '+cl['mon_diskstatus']),
              TD("sync", _class=cellclass+' '+cl['mon_syncstatus']),
              TD("app", _class=cellclass+' '+cl['mon_appstatus']),
            ),
          ),
          _class="svcstatus",
        )
    return t
    pass


""" node checks
"""
def node_checks_line(line, cellclass):
    vars = {
        'chk_nodename':line.v_checks.chk_nodename,
        'chk_svcname':line.v_checks.chk_svcname,
        'chk_type':line.v_checks.chk_type,
        'chk_instance':line.v_checks.chk_instance,
    }
    tr = TR(
      TD(A(line.v_checks.chk_nodename, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.v_checks.chk_nodename})), _class=cellclass),
      TD(A(line.v_checks.chk_svcname, _href=URL(r=request, f='checks_settings_insert', vars=vars)), _class=cellclass),
      TD(A(line.v_checks.chk_type, _href=URL(r=request, f='checks_defaults_insert', vars=vars)), _class=cellclass),
      TD(A(line.v_checks.chk_instance, _href=URL(r=request, f='checks_settings_insert', vars=vars)), _class=cellclass),
      TD(line.v_checks.chk_value, _class=cellclass),
      TD(A(line.v_checks.chk_low, _href=URL(r=request, f='checks_settings_insert', vars=vars)), _class=cellclass),
      TD(A(line.v_checks.chk_high, _href=URL(r=request, f='checks_settings_insert', vars=vars)), _class=cellclass),
    )
    return tr
    pass

def node_checks_header():
    tr = TR(
      TH(T("Node")),
      TH(T("Service")),
      TH(T("Check")),
      TH(T("Instance")),
      TH(T("Value")),
      TH(T("Low threshold")),
      TH(T("High threshold")),
    )
    return tr
    pass

def node_checks_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in checks:
        cellclass = cellclasses[cellclass]
        lines += [node_checks_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Node check alerts")),
            _colspan=99,
          ),
        ),
        node_checks_header(),
        lines,
    )
    return t
    pass

def node_checks():
    if len(checks) == 0:
        return DIV()
    d = DIV(
      node_checks_table(),
      _class="dashboard",
      _id="node_checks",
    )
    return d
    pass


""" Service status not updated
"""
def svcmon_not_updated_line(line, cellclass):
    tr = TR(
      TD(A(line.mon_svcname, _href=URL(r=request, f='svcmon', vars={'mon_svcname':line.mon_svcname})), _class=cellclass),
      TD(A(line.mon_nodname, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.mon_nodname})), _class=cellclass),
      TD(line.mon_updated, _class=cellclass),
      TD(svc_status(line, cellclass), _class=cellclass, _style="text-align:center"),
    )
    return tr
    pass

def svcmon_not_updated_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Node")),
      TH(T("Last updated date")),
      TH(T("Last known status")),
    )
    return tr
    pass

def svcmon_not_updated_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcnotupdated:
        cellclass = cellclasses[cellclass]
        lines += [svcmon_not_updated_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Service status not updated")),
            _colspan=99,
          ),
        ),
        svcmon_not_updated_header(),
        lines,
    )
    return t
    pass

def svcmon_not_updated():
    if len(svcnotupdated) == 0:
        return DIV()
    d = DIV(
      svcmon_not_updated_table(),
      _class="dashboard",
      _id="svcmon_not_updated",
    )
    return d
    pass


""" Last status changes
"""
def last_changes_line(line, cellclass):
    d = prettydate(line.svcmon_log.mon_begin, T)
    tr = TR(
      TD(A(d, _href=URL(r=request, f='svcmon_log', vars={'mon_svcname':line.svcmon_log.mon_svcname})), _class=cellclass),
      TD(A(line.svcmon_log.mon_svcname, _href=URL(r=request, f='svcmon', vars={'mon_svcname':line.svcmon_log.mon_svcname})), _class=cellclass),
      TD(A(line.svcmon_log.mon_nodname, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.svcmon_log.mon_nodname})), _class=cellclass),
      TD(svc_status(line, cellclass, nestedin='svcmon_log'), _class=cellclass, _style="text-align:center"),
    )
    return tr
    pass

def last_changes_header():
    tr = TR(
      TH(T("Since")),
      TH(T("Service")),
      TH(T("Node")),
      TH(T("Status"), _style="text-align:center"),
    )
    return tr
    pass

def last_changes_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in lastchanges:
        cellclass = cellclasses[cellclass]
        lines += [last_changes_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(
              T("Last service status changes"),
            ),
            _colspan=99,
          ),
        ),
        last_changes_header(),
        lines,
    )
    return t
    pass

def last_changes():
    if len(lastchanges) == 0:
        return DIV()
    d = DIV(
      last_changes_table(),
      _class="dashboard",
      _id="last_changes",
    )
    return d
    pass


""" Services with unacknowleged errors
"""
def svc_with_errors_line(line, cellclass):
    tr = TR(
      TD(A(line.svc_name, _href=URL(r=request, f='svcmon', vars={'mon_svcname':line.svc_name})), _class=cellclass),
      TD(line.svc_type, _class=cellclass),
      TD(A(line.err, _href=URL(r=request,f='svcactions', vars={'svcname': line.svc_name, 'status': 'err', 'ack': '!1|empty'})), _class=cellclass),
      TD(svc_status(line, cellclass), _class=cellclass, _style="text-align:center"),
    )
    return tr
    pass

def svc_with_errors_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Env")),
      TH(T("Error count")),
      TH(T("Status"), _style="text-align:center"),
    )
    return tr
    pass

def svc_with_errors_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcwitherrors:
        cellclass = cellclasses[cellclass]
        lines += [svc_with_errors_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Services with errors")),
            _colspan=99,
          ),
        ),
        svc_with_errors_header(),
        lines,
    )
    return t
    pass

def svc_with_errors():
    if len(svcwitherrors) == 0:
        return DIV()
    d = DIV(
      svc_with_errors_table(),
      _class="dashboard",
      _id="svc_with_errors",
    )
    return d
    pass


""" pkg differences amongst cluster nodes
"""
def pkg_diff_line(line, cellclass):
    tr = TR(
      TD(
        line.replace(',', ', '),
        _class=cellclass,
        _style="cursor:help",
        _onclick="""
               getElementById("pkgnodes").value="%(nodes)s";
               ajax("%(url)s",['pkgnodes'],"panelbody_%(a)s");
               getElementById("panel_%(a)s").className="panel_shown";
               getElementById("panel_%(a)s").style.top=event.pageY+'px';
            """%dict(url=URL(r=request,f='ajax_pkgdiff'), nodes=line, a='pkgdiff'),
      ),
      TD(
        pkgdiff[line],
        _class=cellclass,
        _style="cursor:help",
        _onclick="""
               getElementById("pkgnodes").value="%(nodes)s";
               ajax("%(url)s",['pkgnodes'],"panelbody_%(a)s");
               getElementById("panel_%(a)s").className="panel_shown";
               getElementById("panel_%(a)s").style.top=event.pageY+'px';
            """%dict(url=URL(r=request,f='ajax_pkgdiff'), nodes=line, a='pkgdiff'),
      ),
    )
    return tr
    pass

def pkg_diff_header():
    tr = TR(
      TH(T("Cluster")),
      TH(T("Number of package differences")),
    )
    return tr
    pass

def pkg_diff_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in sorted(pkgdiff, key=pkgdiff.__getitem__):
        cellclass = cellclasses[cellclass]
        lines += [pkg_diff_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Package differences amongst cluster nodes")),
            _colspan=99,
          ),
        ),
        pkg_diff_header(),
        lines,
    )
    return t
    pass

def pkg_diff():
    if len(pkgdiff) == 0:
        return DIV()
    d = DIV(
      PANEL('pkgdiff'),
      INPUT(_id='pkgnodes', _type='hidden'),
      pkg_diff_table(),
      _class="dashboard",
      _id="pkg_diff",
    )
    return d
    pass


""" Services not up on all nodes
"""
def svc_not_up_line(line, cellclass):
    tr = TR(
      TD(A(line.v_svc_group_status.svcname, _href=URL(r=request, f='svcmon', vars={'mon_svcname':line.v_svc_group_status.svcname})), _class=cellclass),
      TD(line.v_svc_group_status.svctype, _class=cellclass),
      TD(line.v_svc_group_status.nodes.replace(',', ', '), _class=cellclass),
      TD(line.v_svc_group_status.groupstatus.replace(',', ', '), _class=cellclass),
    )
    return tr
    pass

def svc_not_up_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Env")),
      TH(T("Cluster")),
      TH(T("Cluster status")),
    )
    return tr
    pass

def svc_not_up_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcnotup:
        cellclass = cellclasses[cellclass]
        lines += [svc_not_up_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Services not up")),
            _colspan=99,
          ),
        ),
        svc_not_up_header(),
        lines,
    )
    return t
    pass

def svc_not_up():
    if len(svcnotup) == 0:
        return DIV()
    d = DIV(
      svc_not_up_table(),
      _class="dashboard",
      _id="svc_not_up",
    )
    return d
    pass


""" Services not up on their primary node
"""
def svc_not_on_primary_line(line, cellclass):
    tr = TR(
      TD(A(line.svc_name, _href=URL(r=request, f='svcmon', vars={'mon_svcname':line.svc_name})), _class=cellclass),
      TD(A(line.svc_autostart, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.svc_autostart})), _class=cellclass),
      TD(line.svc_type, _class=cellclass),
      TD(svc_status(line, cellclass), _class=cellclass, _style="text-align:center"),
    )
    return tr
    pass

def svc_not_on_primary_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Primary")),
      TH(T("Env")),
      TH(T("Status on primary"), _style="text-align:center"),
    )
    return tr
    pass

def svc_not_on_primary_table(svcnotonprimary):
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in svcnotonprimary:
        cellclass = cellclasses[cellclass]
        lines += [svc_not_on_primary_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Services not up on primary")),
            _colspan=99,
          ),
        ),
        svc_not_on_primary_header(),
        lines,
    )
    return t
    pass

def svc_not_on_primary():
    svcnotup_names = [s.v_svc_group_status.svcname for s in svcnotup]
    list = [s for s in svcnotonprimary if s.svc_name not in svcnotup_names]
    if len(list) == 0:
        return DIV()
    d = DIV(
      svc_not_on_primary_table(list),
      _class="dashboard",
      _id="svc_not_on_primary",
    )
    return d
    pass


""" Applications without responsibles
"""
def app_wo_resp_line(line, cellclass):
    tr = TR(
      TD(line.app, _class=cellclass),
    )
    return tr
    pass

def app_wo_resp_header():
    tr = TR(
      TH(T("App")),
    )
    return tr
    pass

def app_wo_resp_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in appwithoutresp:
        cellclass = cellclasses[cellclass]
        lines += [app_wo_resp_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
           H2(T("Application without responsibles")),
            _colspan=99,
          ),
        ),
        app_wo_resp_header(),
        lines,
    )
    return t
    pass

def app_wo_resp():
    if len(appwithoutresp) == 0:
        return DIV()
    d = DIV(
      app_wo_resp_table(),
      _class="dashboard",
      _id="app_wo_resp",
    )
    return d
    pass


""" Systems close to warranty end
"""
def warranty_end_line(line, cellclass):
    tr = TR(
      TD(A(line.nodename, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.nodename})), _class=cellclass),
      TD(line.warranty_end, _class=cellclass),
    )
    return tr
    pass

def warranty_end_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Warranty end")),
    )
    return tr
    pass

def warranty_end_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in warrantyend:
        cellclass = cellclasses[cellclass]
        lines += [warranty_end_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes close to warranty end")),
            _colspan=99,
          ),
        ),
        warranty_end_header(),
        lines,
    )
    return t
    pass

def warranty_end():
    if len(warrantyend) == 0:
        return DIV()
    d = DIV(
      warranty_end_table(),
      _class="dashboard",
      _id="warranty_end",
    )
    return d
    pass


""" Systems obsolescent (alert)
"""
def obs_os_alert_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_alert_date, _class=cellclass),
    )
    return tr
    pass

def obs_os_alert_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Operating system")),
      TH(T("Alert since")),
    )
    return tr
    pass

def obs_os_alert_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obsosalert:
        cellclass = cellclasses[cellclass]
        lines += [obs_os_alert_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes with obsolescent operating system (alert)")),
            _colspan=99,
          ),
        ),
        obs_os_alert_header(),
        lines,
    )
    return t
    pass

def obs_os_alert():
    if len(obsosalert) == 0:
        return DIV()
    d = DIV(
      obs_os_alert_table(),
      _class="dashboard",
      _id="obs_os_alert",
    )
    return d
    pass


""" Systems obsolescent (warning)
"""
def obs_os_warn_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_warn_date, _class=cellclass),
    )
    return tr
    pass

def obs_os_warn_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Operating system")),
      TH(T("Warning since")),
    )
    return tr
    pass

def obs_os_warn_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obsoswarn:
        cellclass = cellclasses[cellclass]
        lines += [obs_os_warn_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes with obsolescent operating system (warn)")),
            _colspan=99,
          ),
        ),
        obs_os_warn_header(),
        lines,
    )
    return t
    pass

def obs_os_warn():
    if len(obsoswarn) == 0:
        return DIV()
    d = DIV(
      obs_os_warn_table(),
      _class="dashboard",
      _id="obs_os_warn",
    )
    return d
    pass


""" Model obsolescent (warning)
"""
def obs_hw_warn_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_warn_date, _class=cellclass),
    )
    return tr
    pass

def obs_hw_warn_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Model")),
      TH(T("Warning since")),
    )
    return tr
    pass

def obs_hw_warn_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obshwwarn:
        cellclass = cellclasses[cellclass]
        lines += [obs_hw_warn_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes with obsolescent hardware (warn)")),
            _colspan=99,
          ),
        ),
        obs_hw_warn_header(),
        lines,
    )
    return t
    pass

def obs_hw_warn():
    if len(obshwwarn) == 0:
        return DIV()
    d = DIV(
      obs_hw_warn_table(),
      _class="dashboard",
      _id="obs_hw_warn",
    )
    return d
    pass


""" Model obsolescent (alert)
"""
def obs_hw_alert_line(line, cellclass):
    tr = TR(
      TD(A(line.v_nodes.nodename, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.v_nodes.nodename})), _class=cellclass),
      TD(line.obsolescence.obs_name, _class=cellclass),
      TD(line.obsolescence.obs_alert_date, _class=cellclass),
    )
    return tr
    pass

def obs_hw_alert_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Model")),
      TH(T("Alert since")),
    )
    return tr
    pass

def obs_hw_alert_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in obshwalert:
        cellclass = cellclasses[cellclass]
        lines += [obs_hw_alert_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes with obsolescent hardware (alert)")),
            _colspan=99,
          ),
        ),
        obs_hw_alert_header(),
        lines,
    )
    return t
    pass

def obs_hw_alert():
    if len(obshwalert) == 0:
        return DIV()
    d = DIV(
      obs_hw_alert_table(),
      _class="dashboard",
      _id="obs_hw_alert",
    )
    return d
    pass


""" Obsolescence information missing
"""
def obs_miss():
    if obswarnmiss + obsalertmiss == 0:
        return DIV()
    return DIV(
      TABLE(
        TR(
          TD(
            H2(T("Items with missing obsolescence information")),
            _colspan=99,
          ),
        ),
        TR(
          TH(T("Date not set")),
          TH(T("Item count")),
        ),
        TR(
          TD(T("Warn")),
          TD(A(obswarnmiss, _href=(URL(r=request, f='obsolescence_config', vars={'obs_warn_date': 'empty|0000-00-00 00:00:00'})))),
        ),
        TR(
          TD(T("Alert"), _class="cell1"),
          TD(A(obsalertmiss, _href=(URL(r=request, f='obsolescence_config', vars={'obs_alert_date': 'empty|0000-00-00 00:00:00'}))), _class="cell1"),
        ),
      ),
      _class="dashboard",
      _id="obs_miss",
    )
    pass


""" Nodes without asset
"""
def nodes_without_asset_line(line, cellclass):
    tr = TR(
      TD(A(line.mon_nodname, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.mon_nodname})), _class=cellclass),
    )
    return tr
    pass

def nodes_without_asset_header():
    tr = TR(
      TH(T("Nodename")),
    )
    return tr
    pass

def nodes_without_asset_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in nodeswithoutasset:
        cellclass = cellclasses[cellclass]
        lines += [nodes_without_asset_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes without asset information")),
            _colspan=99,
          ),
        ),
        nodes_without_asset_header(),
        lines,
    )
    return t
    pass

def nodes_without_asset():
    if len(nodeswithoutasset) == 0:
        return DIV()
    d = DIV(
      nodes_without_asset_table(),
      _class="dashboard",
      _id="nodes_without_asset",
    )
    return d
    pass


""" Frozen services
"""
def frozen_line(line, cellclass):
    tr = TR(
      TD(A(line.mon_svcname, _href=URL(r=request, f='svcmon', vars={'mon_svcname':line.mon_svcname})), _class=cellclass),
      TD(A(line.mon_nodname, _href=URL(r=request, f='svcmon', vars={'mon_nodname':line.mon_nodname})), _class=cellclass),
    )
    return tr
    pass

def frozen_header():
    tr = TR(
      TH(T("Service")),
      TH(T("Nodename")),
    )
    return tr
    pass

def frozen_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in frozen:
        cellclass = cellclasses[cellclass]
        lines += [frozen_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Frozen services")),
            _colspan=99,
          ),
        ),
        frozen_header(),
        lines,
    )
    return t
    pass

def frozen_services():
    if len(frozen) == 0:
        return DIV()
    d = DIV(
      frozen_table(),
      _class="dashboard",
      _id="frozen",
    )
    return d
    pass


""" Netdev errors
"""
def netdev_err_line(line, cellclass):
    tr = TR(
      TD(
        A(
          line.v_stats_netdev_err_avg_last_day.nodename,
          _href=URL(
                  r=request,
                  f='svcmon',
                  vars={'mon_nodname':line.v_stats_netdev_err_avg_last_day.nodename}
                )
        ),
        _class=cellclass
      ),
      TD(line.v_stats_netdev_err_avg_last_day.dev, _class=cellclass),
      TD("%.02f"%line.v_stats_netdev_err_avg_last_day.avgrxerrps, _class=cellclass),
      TD("%.02f"%line.v_stats_netdev_err_avg_last_day.avgtxerrps, _class=cellclass),
      TD("%.02f"%line.v_stats_netdev_err_avg_last_day.avgcollps, _class=cellclass),
      TD("%.02f"%line.v_stats_netdev_err_avg_last_day.avgrxdropps, _class=cellclass),
      TD("%.02f"%line.v_stats_netdev_err_avg_last_day.avgtxdropps, _class=cellclass),
    )
    return tr
    pass

def netdev_err_header():
    tr = TR(
      TH(T("Nodename")),
      TH(T("Device")),
      TH(T("Avg rx err/s")),
      TH(T("Avg tx err/s")),
      TH(T("Avg coll/s")),
      TH(T("Avg rx drop/s")),
      TH(T("Avg tx drop/s")),
    )
    return tr
    pass

def netdev_err_table():
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    lines = []

    for line in netdeverrs:
        cellclass = cellclasses[cellclass]
        lines += [netdev_err_line(line, cellclass)]
        pass

    t = TABLE(
        TR(
          TD(
            H2(T("Nodes with network device errors in the last day")),
            _colspan=99,
          ),
        ),
        netdev_err_header(),
        lines,
    )
    return t
    pass

def netdev_err():
    if len(netdeverrs) == 0:
        return DIV()
    d = DIV(
      netdev_err_table(),
      _class="dashboard",
      _id="netdev_err",
    )
    return d
    pass


""" Summary
"""
def _summary():
    svcnotup_names = [s.v_svc_group_status.svcname for s in svcnotup]
    svcnotup_names_filtered = [s for s in svcnotonprimary if s.svc_name not in svcnotup_names]
    now = datetime.datetime.now()
    onehourago = now - datetime.timedelta(minutes=60)

    _hash = [{
               'title': 'Node check alerts',
               'unit': '',
               'limit': 0,
               'linkto': 'node_checks',
               'status': len(checks),
             },
             {
               'title': 'Services not up',
               'unit': '',
               'limit': 0,
               'linkto': 'svc_not_up',
               'status': len(svcnotup),
             },
             {
               'title': 'Frozen services',
               'unit': '',
               'limit': 0,
               'linkto': 'frozen',
               'status': len(frozen),
             },
             {
               'title': 'Service status not updated',
               'unit': '',
               'limit': 0,
               'linkto': 'svcmon_not_updated',
               'status': len(svcnotupdated),
             },
             {
               'title': 'Services with errors',
               'unit': '',
               'limit': 0,
               'linkto': 'svc_with_errors',
               'status': len(svcwitherrors),
             },
             {
               'title': 'Services not up on primary',
               'unit': '',
               'limit': 0,
               'linkto': 'svc_not_on_primary',
               'status': len(svcnotup_names_filtered),
             },
             {
               'title': 'Last service status changes',
               'unit': '/h',
               'limit': 20,
               'linkto': 'last_changes',
               'status': len([c for c in lastchanges if c.svcmon_log.mon_begin > onehourago]),
             },
             {
               'title': 'Application without responsibles',
               'unit': '',
               'limit': 0,
               'linkto': 'app_wo_resp',
               'status': len(appwithoutresp),
             },
             {
               'title': 'Nodes close to warranty end',
               'unit': '',
               'limit': 0,
               'linkto': 'warranty_end',
               'status': len(warrantyend),
             },
             {
               'title': 'Nodes with obsolescent operating system (alert)',
               'unit': '',
               'limit': 0,
               'linkto': 'obs_os_alert',
               'status': len(obsosalert),
             },
             {
               'title': 'Nodes with obsolescent operating system (warn)',
               'unit': '',
               'limit': 0,
               'linkto': 'obs_os_warn',
               'status': len(obsoswarn),
             },
             {
               'title': 'Nodes with obsolescent hardware (alert)',
               'unit': '',
               'limit': 0,
               'linkto': 'obs_hw_alert',
               'status': len(obshwalert),
             },
             {
               'title': 'Nodes with obsolescent hardware (warn)',
               'unit': '',
               'limit': 0,
               'linkto': 'obs_hw_warn',
               'status': len(obshwwarn),
             },
             {
               'title': 'Items with missing obsolescence information (alert)',
               'unit': '',
               'limit': 0,
               'linkto': 'obs_miss',
               'status': obsalertmiss,
             },
             {
               'title': 'Items with missing obsolescence information (warn)',
               'unit': '',
               'limit': 0,
               'linkto': 'obs_miss',
               'status': obswarnmiss,
             },
             {
               'title': 'Nodes without asset information',
               'unit': '',
               'limit': 0,
               'linkto': 'nodes_without_asset',
               'status': len(nodeswithoutasset),
             },
             {
               'title': 'Clusters with package differences amongst nodes',
               'unit': '',
               'limit': 0,
               'linkto': 'pkg_diff',
               'status': len(pkgdiff),
             },
             {
               'title': 'Nodes with network device errors in the last day',
               'unit': '',
               'limit': 0,
               'linkto': 'netdev_err',
               'status': len(netdeverrs),
             }]

    return _hash
    pass

def summary_header():
    tr = TR(
      TH(T("Report")),
      TH(T("Status")),
    )
    return tr
    pass

def summary_line(l, cellclass):
    if l['status'] > l['limit']:
        color = 'color:darkred;font-weight:bold;'
        status = 'bad'
        rowstyle = ''
    else:
        color = ''
        status = 'good'
        rowstyle = 'display:none'
    pass
    line = TR(
             TD(
               T(l['title']),
               _class=cellclass,
             ),
             TD(
               str(l['status'])+l['unit'],
               _class=cellclass,
               _style=color,
             ),
             _onclick="ScrollToElement(getElementById('%s'))"%l['linkto'],
             _name="summary_line_"+status,
             _style='cursor:pointer;'+rowstyle,
           )
    return line

def summary_table():
    cellclass = 'cell1'
    cellclasses = {'cell1': 'cell2', 'cell2': 'cell1'}
    head = []
    foot = []
    lines = []

    summary_hash = _summary()

    for l in summary_hash:
        if l['status'] <= l['limit']:
            foot.append(l)
        else:
            head.append(l)
        pass
    pass
    for l in head + foot:
        cellclass = cellclasses[cellclass]
        lines.append(summary_line(l, cellclass))
    pass

    t = TABLE(
          TR(
            TD(
              H2(
                T("Summary"),
                SPAN(
                  "(%s)"%(now - datetime.timedelta(microseconds=now.microsecond)),
                  _style="""font-size:0.6em;
                            padding-left:1em;
                         """,
                ),
              ),
              _colspan=99,
            ),
            _onclick="toggle_vis('summary_line_good')",
            _style="cursor:help",
          ),
          summary_header(),
          lines,
        )
    return t
    pass

def summary():
    d = DIV(
      summary_table(),
      _class="dashboard",
    )
    return d
    pass
}}

{{=FORM(
     DB_FILTERS_TABLE(active_filters, available_filters),
     _action=URL(r=request, f='index'),
     _name='svcform',
     _id='svcform',
   )
}}
{{=DIV(
     DIV(
       summary(),
       _class="container",
     ),
     node_checks(),
     svc_not_up(),
     frozen_services(),
     svcmon_not_updated(),
     svc_with_errors(),
     svc_not_on_primary(),
     last_changes(),
     app_wo_resp(),
     warranty_end(),
     obs_os_alert(),
     obs_os_warn(),
     obs_hw_alert(),
     obs_hw_warn(),
     obs_miss(),
     nodes_without_asset(),
     pkg_diff(),
     netdev_err(),
     _style="""
       column-width:50em;
       -moz-column-width:50em;
       -webkit-column-width:50em;
     """
   )
}}

