{{extend 'layout.html'}}
{{include '../static/jslib.html'}}
{{include 'box.html'}}
{{include 'panel.html'}}
{{include 'filters.html'}}
{{include 'lib.html'}}
{{
initialize_keys()
}}
{{
def pid_to_filter(pid):
    if pid is None:
        return ''
    return pid.replace(',', '|')
pass

def format_svcname(row, new=True, cellclass=""):
    key = "svcname"
    if not new:
        return TD(
                 _name="tcol_"+key,
                 _style=col_hide(key),
                 _class=cellclass,
               )

    return TD(
             DIV(
               A(
                 row.svcname,
                 _onclick="""
                   getElementById("node").value="%(node)s";
                   getElementById("rowid").value="%(id)s";
                   ajax("%(url)s",['node', 'rowid'],"id_%(id)s");
                   show_eid("tr_id_%(id)s");
                 """%dict(url=URL(r=request,f='ajax_service'),
                          node=row.svcname,
                          id=row.id,
                         ),
               ),
               _class="xinfo",
             ),
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=cellclass,
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
           )
    pass

def format_hostname(row, new=True, cellclass=""):
    key = "hostname"

    if not new:
        return TD(
                 _name="tcol_"+key, 
                 _style=col_hide(key),
                 _class=cellclass,
               )

    return TD(
             DIV(
               node_icon(row.os_name),
               A(
                 row.hostname,
                 _onclick="""
                   getElementById("node").value="%(node)s";
                   getElementById("rowid").value="%(id)s";
                   ajax("%(url)s",['node', 'rowid'],"id_%(id)s");
                   show_eid("tr_id_%(id)s");
                 """%dict(url=URL(r=request,f='ajax_node'),
                          node=row.hostname,
                          id=row.id,
                         ),
               ),
               _class="xinfo",
             ),
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=cellclass,
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
           )
    pass

def format_status(row, cellclass=""):
    key = 'status'

    if not action.status_log:
        action.status_log = ''
        metaactionclass = 'metaaction'
    else:
        metaactionclass = ''
    pass

    if action.ack == 1:
        onmouseover = """onMouseOver=show_eid("%s")"""%eid
        onmouseout = """onMouseOut=hide_eid("%s")"""%eid
        ack_class = "ack_1"
    else:
        onmouseover = ""
        onmouseout = ""
        ack_class = ""
    pass

    if action.status is None:
        action_status = SPAN(
          INPUT(
            _id="spin_"+str(action.id),
            _type="hidden",
          ),
          SPAN(
            IMG(
              _src=URL(r=request,c='static',f='spinner_16.png'),
              _border=0,
              _title=T("unfinished"),
              _onload="""
                var spintimer_%(id)s;
                getElementById('spin_%(id)s').value=%(id)s;
                clearTimeout(spintimer_%(id)s);
                spintimer=setTimeout(function validate(){ajax('%(url)s', ['spin_%(id)s'], 'spin_span_%(id)s')}, 3000);
              """%dict(
                    url=URL(r=request,f='ajax_action_status'),
                    id=action.id,
                  )
            ),
            _id="spin_span_"+str(action.id),
          ),
        )
    else:
        action_status = action.status
    pass

    return TD(
             action_status,
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=' '.join([cellclass, 'status_'+str(row.status), ack_class, metaactionclass]),
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
             _onmouseover=onmouseover,
             _onmouseout=onmouseout,
           )
    pass

def format_status_log(row, key, new, cellclass=""):
    if not new:
        return TD(
                 _name="tcol_"+key, 
                 _style=col_hide(key),
                 _class=cellclass,
               )

    return TD(PRE(
             row[key],
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=cellclass,
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
           ))
    pass

def format_generic(row, key, new, cellclass=""):
    if not new:
        return TD(
                 _name="tcol_"+key, 
                 _style=col_hide(key),
                 _class=cellclass,
               )

    return TD(
             row[key],
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=cellclass,
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
           )
    pass

def format_pid(row, new, cellclass=""):
    key = 'pid'
    if not new:
        return TD(
                 _name="tcol_"+key, 
                 _style=col_hide(key),
                 _class=cellclass,
               )

    if row.pid is None:
        action_pid = SPAN(
              _id="spin_span_pid_"+str(row.id),
          )
    else:
        if action.end is None:
            end = action.begin
        else:
            end = action.end
        pass

        action_pid = A(
           row.pid,
           _href=URL(
                   r=request,
                   vars={
                     'pid':pid_to_filter(row.pid),
                     'hostname':row.hostname,
                     'svcname':row.svcname,
                     'begin':'>'+str(row.begin-datetime.timedelta(days=1)),
                     'end':'<'+str(end+datetime.timedelta(days=1)),
                     'perpage':0,
                   }
          ),
        )
    pass

    return TD(
             action_pid,
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=cellclass,
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
           )
    pass

def format_end(row, new, cellclass=""):
    key = 'end'
    if not new:
        return TD(
                 _name="tcol_"+key, 
                 _style=col_hide(key),
                 _class=cellclass,
               )

    if action.end is None:
        action_end = SPAN(
            _id="spin_span_end_"+str(action.id),
        )
    else:
        action_end = action.end
    pass

    return TD(
             action_end,
             _name="tcol_"+key, 
             _style=col_hide(key),
             _class=cellclass,
             _ondblclick="svcform.%(key)s.value='%(val)s';svcform.submit()"%dict(key=key, val=row[key]),
           )
    pass


}}
{{=PANEL("column_values")}}
<form action='svcactions' name='svcform' id='svcform' method='post'> 
<input id='node' type='hidden'>
<input id='rowid' type='hidden'>
{{=DB_FILTERS_TABLE(active_filters, available_filters)}}
<table class=datatable>
  <tr class=box>
    <td class=box></td>
    {{for key in colkeys:}}
    <td name="tcol_{{=key}}" style="{{=col_hide(key)}}">
      {{=colname(actions, key, columns[key]['title'])}}
    </td>
    {{pass}}
  </tr>
  <tr class=box>
    <td><input type=checkbox id=check_all onClick="select_all(document.getElementById('check_all').checked, document.getElementById('svcform'))"></td>
    {{for key in colkeys:}}
    <td name="tcol_{{=key}}" style="{{=col_hide(key)}}"><input name={{=key}} value='{{=request.vars[key]}}' size={{=columns[key]['size']}} onKeyPress="checkEnter(event)"></td>
    {{pass}}
  </tr>
  {{
    pid = ''
    svcname = ''
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    r = range(len(actions))
    r.reverse()
  }}
  {{for i in r:}}
    {{action = actions[i]}}
    {{
      if pid != action.pid or svcname != action.svcname or pid is None:
          cellclass = cellclasses[cellclass]
          pid = action.pid
          svcname = action.svcname
          new = True
      else:
          new = False
          pass

      checked = getattr(request.vars, 'check_'+str(action.id))

      if checked is not None:
          checked = 'checked=on'
          pass

      if action.status == 'err':
          disabled = ''
      else:
          disabled = 'disabled'
          pass

      eid = 'ack_'+str(action.id)

      if action.ack == 1:
          trigger = """onMouseOver=show_eid("%(eid)s")
                       onMouseOut=hide_eid("%(eid)s")
                    """%dict(eid=eid)
          ack = TR(TD(B("acked by "),action.acked_by,B(" on "),action.acked_date,B(" with comment: "),action.acked_comment,_colspan=99), _class='ack', _id=eid)
      else:
          trigger = ""
          ack = TR(TD("", _colspan=99), _class='ack', _id=eid)
          pass

    }}
  <tr>
    <td class={{=cellclass}}><input type=checkbox name=check_{{=action.id}} {{=checked}} {{=disabled}}></td>
    {{for key in colkeys:}}
        {{if key == "svcname":}}
            {{=format_svcname(action, new, cellclass)}}
        {{elif key == "hostname":}}
            {{=format_hostname(action, new, cellclass)}}
        {{elif key == "status":}}
            {{=format_status(action, cellclass)}}
        {{elif key == "pid":}}
            {{=format_pid(action, new, cellclass)}}
        {{elif key == "end":}}
            {{=format_end(action, new, cellclass)}}
        {{elif key == "status_log":}}
            {{=format_status_log(action, key, True, cellclass)}}
        {{else:}}
            {{=format_generic(action, key, True, cellclass)}}
        {{pass}}
    {{pass}}
  </tr>
  <tr id='tr_id_{{=action.id}}' class=cloud>
    <td colspan=99 class="details_row {{=cellclass}}">
      <div id='id_{{=action.id}}'>
      </div>
    </td>
  </tr>
  {{=ack}}
  {{pass}}
  <tr class=box>
    <td align=center colspan=99>{{=nav}}</td>
  </tr>
  <tr class=box>
    <td colspan=99>
      <table>
        <tr class=box>
          <td> {{=T('Export')}}:</td>
          <td> {{=T('Rss')}}:</td>
          <td> {{=T('Actions')}}:</td>
        </tr>
        <tr class=box>
          <td>
            {{=A(IMG(_src=URL(r=request,c='static',f='csv.png'),_border=0, _title=T("print the csv representation of the current data cursor")),_href=URL(r=request,f='svcactions_csv', vars=request.vars))}}
          </td>
          <td>
            {{=A(IMG(_src=URL(r=request,c='static',f='rss.png'),_border=0),_href=URL(r=request,f='svcactions_rss', vars=request.vars))}}
          </td>
          <td>
            {{=IMG(_src=URL(r=request,c='static',f='ack.png'),_border=0, _title=T('acknowledge selected errors'), _onclick='javascript:getElementById("ackflag").value=1;show_eid("inputs");document.svcform.ackcomment.focus()')}}
          </td>
        </tr>
        <tr class=hidden id="inputs">
          <td></td>
          <td></td>
          <td>
            {{=T('Acknowledge with comment')}}:<br>
            <input name=ackflag id=ackflag value=0 type=hidden>
            <input name=ackcomment onKeyPress="checkEnter(event)" onBlur="getElementById('ackflag').value=0;hide_eid('inputs')">
          </td>
        </tr>
      </table>
    </td>
   </tr>
</table>
</form>
