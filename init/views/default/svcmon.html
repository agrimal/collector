{{extend 'layout.html'}}
{{include '../static/jslib.html'}}
{{include 'box.html'}}
{{include 'panel.html'}}
{{include 'filters.html'}}
{{include 'lib.html'}}

{{

user=' '.join([session.auth.user.first_name, session.auth.user.last_name])
vars = request.vars
toolong = datetime.datetime.today()-datetime.timedelta(hours=1)
initialize_keys()

def ajax_status(svc, name, cssclass):
    a = svc.mon_nodname+'_'+svc.svc_name
    a = a.replace('.', '_')
    return DIV(
            name,
            _class=cssclass,
            _style="cursor:help",
            _onclick="""
               getElementById("node").value="%(node)s";
               getElementById("mon_svcname").value="%(mon_svcname)s";
               ajax("%(url)s",['node', 'mon_svcname'],"panelbody_%(a)s");
               getElementById("panel_%(a)s").className="panel_shown";
               getElementById("panel_%(a)s").style.top=event.pageY+'px';
            """%dict(url=URL(r=request,f='ajax_res_status'), node=svc.mon_nodname, mon_svcname=svc.svc_name, a=a),
          )
    pass


def svc_status(svc, cellclass="cell2"):
    cl = {}
    import time
    time_format = "%Y-%m-%d %H:%M:%S"
    updated = svc.mon_updated
    for k in ['mon_overallstatus',
              'mon_containerstatus',
              'mon_ipstatus',
              'mon_fsstatus',
              'mon_diskstatus',
              'mon_syncstatus',
              'mon_appstatus']:
        if svc[k] is None:
            cl[k] = 'status_undef'
        elif updated < toolong:
            cl[k] = 'status_expired'
        else:
            cl[k] = 'status_'+svc[k].replace(" ", "_")
        pass
    pass

}}
{{=PANEL(svc.mon_nodname+'_'+svc.svc_name)}}
{{
    t = DIV(
          TABLE(
            TR(
              TD(
                ajax_status(svc, svc.mon_overallstatus,
                            ' '.join(["status", cl['mon_overallstatus']])),
                _colspan=6,
                _title="since "+str(svc.mon_updated),
              ),
            ),
            TR(
              TD("vm", _class=cellclass+' '+cl['mon_containerstatus']),
              TD("ip", _class=cellclass+' '+cl['mon_ipstatus']),
              TD("fs", _class=cellclass+' '+cl['mon_fsstatus']),
              TD("dg", _class=cellclass+' '+cl['mon_diskstatus']),
              TD("sync", _class=cellclass+' '+cl['mon_syncstatus']),
              TD("app", _class=cellclass+' '+cl['mon_appstatus']),
            ),
          ),
          _class="svcstatus",
        )
    return t
    pass

}}

<input id="mon_svcname" type="hidden">
<input id="node" type="hidden">
{{=PANEL("column_values")}}
<form action='svcmon' name='svcform' id='svcform' method='post'> 
{{=DB_FILTERS_TABLE(active_filters, available_filters)}}
<input id='node' type='hidden'>
<input id='rowid' type='hidden'>
<table class=datatable>
  <tr class=box>
    <td class=box></td>
    <td class=box></td>
    <td name="tcol_mon_svcname" style="{{=col_hide('mon_svcname')}}">{{=colname(services, 'svc_name', T('Service'))}}</td>
    <td name="tcol_svc_containertype" style="{{=col_hide('svc_containertype')}};max-width:1em">{{=colname(services, 'svc_containertype', T('Container type'))}}</td>
    <td name="tcol_svc_vcpus" style="{{=col_hide('svc_vcpus')}}" class=status_t>{{=columns['svc_vcpus']['title']}}</td>
    <td name="tcol_svc_vmem" style="{{=col_hide('svc_vmem')}}" class=status_t>{{=columns['svc_vmem']['title']}}</td>
    <td name="tcol_svc_app" style="{{=col_hide('svc_app')}};max-width:1em">{{=colname(services, 'svc_app', T('App'))}}</td>
    <td name="tcol_mon_svctype" style="{{=col_hide('mon_svctype')}};max-width:1em">{{=colname(services, 'mon_svctype', T('Service type'))}}</td>
    <td name="tcol_responsibles" style="{{=col_hide('responsibles')}};max-width:1em">{{=colname(services, 'responsibles', T('Responsibles'))}}</td>
    <td name="tcol_mon_nodtype" style="{{=col_hide('mon_nodtype')}};max-width:1em">{{=colname(services, 'mon_nodtype', T('Node type'))}}</td>
    <td name="tcol_mon_nodname" style="{{=col_hide('mon_nodname')}}">{{=colname(services, 'mon_nodname', T('Node'))}}</td>
    <td name="tcol_overallstatus" style="{{=col_hide('overallstatus')}}" class=status_t>{{=T('Status')}}</td>
    <td name="tcol_mon_updated" style="{{=col_hide('mon_updated')}}" class=status_t>{{=columns['mon_updated']['title']}}</td>
    <td name="tcol_mon_frozen" style="{{=col_hide('mon_frozen')}}" class=status_t>{{=columns['mon_frozen']['title']}}</td>
  </tr>
  <tr class=box>
    <td><input type=checkbox id=check_all onClick="select_all(document.getElementById('check_all').checked, document.getElementById('svcform'))"></td>
    <td style='padding:0'></td>
    <td name="tcol_mon_svcname" style="{{=col_hide('mon_svcname')}}"><input name=mon_svcname value='{{=vars.mon_svcname}}' size=12 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_svc_containertype" style="{{=col_hide('svc_containertype')}}"><input name=svc_containertype value='{{=vars.svc_containertype}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_svc_vcpus" style="{{=col_hide('svc_vcpus')}}" class=status_t><input name=svc_vcpus value='{{=vars.svc_vcpus}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_svc_vmem" style="{{=col_hide('svc_vmem')}}" class=status_t><input name=svc_vmem value='{{=vars.svc_vmem}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_svc_app" style="{{=col_hide('svc_app')}}"><input name=svc_app value='{{=vars.svc_app}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_mon_svctype" style="{{=col_hide('mon_svctype')}}"><input name=mon_svctype value='{{=vars.mon_svctype}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_responsibles" style="{{=col_hide('responsibles')}}"><input name=responsibles value='{{=vars.responsibles}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_mon_nodtype" style="{{=col_hide('mon_nodtype')}}"><input name=mon_nodtype value='{{=vars.mon_nodtype}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_mon_nodname" style="{{=col_hide('mon_nodname')}}"><input name=mon_nodname value='{{=vars.mon_nodname}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_overallstatus" style="{{=col_hide('overallstatus')}}" class=status_t><input name=overallstatus value='{{=vars.overallstatus}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_mon_updated" style="{{=col_hide('mon_updated')}}" class=status_t><input name=mon_updated value='{{=vars.mon_updated}}' size=4 onKeyPress="checkEnter(event)"></td>
    <td name="tcol_mon_frozen" style="{{=col_hide('mon_frozen')}}" class=status_t><input name=mon_frozen value='{{=vars.mon_frozen}}' size=4 onKeyPress="checkEnter(event)"></td>
  </tr>
  {{
    mon_svcname = ''
    cellclass = 'cell1'
    cellclasses = {}
    cellclasses['cell1'] = 'cell2'
    cellclasses['cell2'] = 'cell1'
    yesterday = str(datetime.datetime.today()-datetime.timedelta(days=1))
    svcbuff = None
  }}

  {{for svc in services:}}
    {{if mon_svcname != svc.mon_svcname or mon_svcname == '':
          cellclass = cellclasses[cellclass]
          mon_svcname = svc.mon_svcname
          newsvc = True
      else:
          newsvc = False
          pass
      if svc.svc_vmname != "" and svc.svc_vmname is not None:
          vmname = svc.svc_vmname
      else:
          vmname = ''
          pass

      if svc.err>0:
          err = A(IMG(_src=URL(r=request,c='static',f='exclamation_red.png'), _border=0, _title="%d unaknowledged errors"%svc.err), _href=URL(r=request,f='svcactions', vars={'svcname': svc.svc_name, 'status': 'err', 'ack': '!1|empty'}))
      else:
          err = ''
          pass

      checked = getattr(vars, 'check_'+str(svc.id))
      if checked is not None:
          checked = 'checked=on'
          pass
      if svc.responsibles is not None and user in svc.responsibles.split(', '):
          disabled = ""
      else:
          disabled = "disabled"
          pass

    }}
    {{if newsvc and svcbuff is not None:}}
    <tr id='tr_id_{{=svcbuff.svc_name}}' class=cloud>
      <td colspan=99 class="details_row {{=cellclasses[cellclass]}}">
        <div id='id_{{=svcbuff.svc_name}}'>
        </div>
      </td>
    </tr>
    {{pass}}
    <tr>
    {{svcbuff = svc}}
    <td class={{=cellclass}}><input type=checkbox name=check_{{=svc.id}} {{=checked}} {{=disabled}}></td>
    <td class={{=cellclass}}>
      <input id="{{=svc.mon_svcname}}" value="{{=svc.mon_svcname}}" type="hidden">
      {{if newsvc:}}
        {{=A(IMG(
               _src=URL(r=request,c='static',f='action16.png'),
               _border=0,
             ),
             _href=URL(request.application,'default','svcactions?svcname='+svc.mon_svcname+'&status_log=empty&begin=>'+yesterday)
           )
        }}
        {{pass}}
       {{if newsvc:}}
      {{if svc.svc_name in svcmsg:
          img = URL(r=request,c='static',f='msg1.png')
        else:
          img = URL(r=request,c='static',f='msg0.png')
          pass
      }}
      {{=A(
          IMG(
            _id="msg_img_"+svc.mon_svcname,
            _src=img,
            _border=0,
            _title="comments",
            _onclick="""
               getElementById("mon_svcname").value="%(mon_svcname)s";
               ajax("%(url)s",['mon_svcname'],"msg__%(mon_svcname)s");
               getElementById("panel_msg_%(a)s").className="panel_shown";
               getElementById("panel_msg_%(a)s").style.top=event.pageY+'px';
            """%dict(url=URL(r=request,f='ajax_svc_message_load'),
                     mon_svcname=svc.mon_svcname,
                     a=svc.mon_svcname.replace('.', '_')
                    ),
          ),
          _class="xinfo",
        )
     }}
     {{=PANEL("msg_"+svc.mon_svcname, DIV(
          DIV(
            TEXTAREA(_id="msgbody_"+svc.mon_svcname),
            _id="msg__"+svc.mon_svcname
          ),
          INPUT(
            _value=T("save"),
            _type="button",
            _onclick="""
              ajax("%(url)s",['mon_svcname','msgbody_%(mon_svcname)s'],"msg__%(mon_svcname)s");
              getElementById("panel_msg_%(a)s").className="panel";
              if (getElementById("msgbody_%(mon_svcname)s").value.length>0)
                getElementById("msg_img_%(mon_svcname)s").src="%(img1)s";
              else
                getElementById("msg_img_%(mon_svcname)s").src="%(img0)s";
            """%dict(url=URL(r=request,f='ajax_svc_message_save'),
                     mon_svcname=svc.mon_svcname,
                     a=svc.mon_svcname.replace('.', '_'),
                     img0=URL(r=request,c='static',f='msg0.png'),
                     img1=URL(r=request,c='static',f='msg1.png'),
                    ),
          ),
          _id="msg_"+svc.mon_svcname,
        ))
      }}
      {{pass}}
      {{=err}}
      {{
        if svc.mon_frozen == 1:
            frozen = IMG(_src=URL(r=request,c='static',f='frozen16.png'), _title=svc.mon_frozen)
        else:
            frozen = ""
        pass
      }}
      {{=frozen}}
    </td>
      {{if svc.mon_svctype == 'PRD':
            boldtype = "font-weight:bold;"
        else:
            boldtype = ""
            pass
      }}
    <td name="tcol_mon_svcname" style="{{=boldtype}}{{=col_hide('mon_svcname')}}" class={{=cellclass}}>
      {{if newsvc:}}
      {{=A(
          DIV(
            svc.svc_name,
            _onclick="""
               getElementById("node").value="%(node)s";
               getElementById("rowid").value="%(id)s";
               ajax("%(url)s",['node', 'rowid'],"id_%(id)s");
               show_eid("tr_id_%(id)s");
            """%dict(url=URL(r=request,f='ajax_service'),
                     node=svc.svc_name,
                     id=svc.svc_name,
                    ),
          ),
          _class="xinfo",
        )
      }}
      {{pass}}
    </td>
    <td name="tcol_svc_containertype" style="{{=col_hide('svc_containertype')}}" class={{=cellclass}}>
      {{if newsvc:}}
        {{=DIV(
             node_icon(svc.svc_guestos),
             svc.svc_containertype,
             _title=vmname,
             _style='vertical-align:middle'
          )
        }}
        {{pass}}
    </td>
    <td name="tcol_svc_vcpus" style="{{=col_hide('svc_vcpus')}}" class="{{=cellclass}}">
      {{if newsvc:}}
        {{=svc.svc_vcpus}}
        {{pass}}
    </td>
    <td name="tcol_svc_vmem" style="{{=col_hide('svc_vmem')}}" class="{{=cellclass}}">
      {{if newsvc:}}
        {{=svc.svc_vmem}}
        {{pass}}
    </td>
    <td name="tcol_svc_app" style="{{=col_hide('svc_app')}}" class={{=cellclass}}>
      {{if newsvc:}}
        {{=svc.svc_app}}
        {{pass}}
    </td>
    <td name="tcol_mon_svctype" style="{{=col_hide('mon_svctype')}}" class={{=cellclass}}>
      {{if newsvc:}}
        {{=svc.mon_svctype}}
        {{pass}}
    </td>
    <td name="tcol_responsibles" style="{{=col_hide('responsibles')}}" class={{=cellclass}}>
      {{if newsvc:}}
        {{=svc.responsibles}}
        {{pass}}
    </td>
    <td name="tcol_mon_nodtype" style="{{=col_hide('mon_nodtype')}}" class={{=cellclass}}>{{=svc.mon_nodtype}}</td>
    {{if svc.mon_nodname == svc.svc_autostart:
          boldtype = "font-weight:bold;"
      else:
          boldtype = ""
          pass
    }}
    <td name="tcol_mon_nodname" style="{{=boldtype}}{{=col_hide('mon_nodname')}}" class={{=cellclass}}>
      {{=A(
          DIV(
            node_icon(svc.os_name),
            svc.mon_nodname,
            _onclick="""
               getElementById("node").value="%(node)s";
               getElementById("rowid").value="%(id)s";
               ajax("%(url)s",['node', 'rowid'],"id_%(id)s");
               show_eid("tr_id_%(id)s");
            """%dict(url=URL(r=request,f='ajax_node'),
                     node=svc.mon_nodname,
                     id=svc.svc_name,
                    ),
          ),
          _class="xinfo",
        )
      }}
    </td>
    <td name="tcol_overallstatus" style="text-align:center;{{=col_hide('overallstatus')}}" class="{{=cellclass}}">
      {{=svc_status(svc,cellclass)}}
    </td>
    <td name="tcol_mon_updated" style="{{=col_hide('mon_updated')}}" class="{{=cellclass}}">
      {{=svc.mon_updated}}
    </td>
    <td name="tcol_mon_frozen" style="{{=col_hide('mon_frozen')}}" class="{{=cellclass}}">
      {{=svc.mon_frozen}}
    </td>
  </tr>
  {{pass}}
  {{if svcbuff is not None:}}
    <tr id='tr_id_{{=svcbuff.svc_name}}' class=cloud>
      <td colspan=99 class="details_row {{=cellclass}}">
        <div id='id_{{=svcbuff.svc_name}}'>
        </div>
      </td>
    </tr>
  {{pass}}

  <tr class=box>
    <td align=center colspan=99>{{=nav}}</td>
  </tr>
  <tr class=box>
    <td colspan=99>
      <table>
        <tr>
          <td> {{=T('Export')}}:</td>
          <td> {{=T('Topology')}}:</td>
          <td> {{=T('Actions')}}:</td>
        </tr>
        <tr>
          <td>
            {{=A(IMG(_src=URL(r=request,c='static',f='csv.png'),_border=0, _title=T("print the csv representation of the current data cursor")),_href=URL(r=request,f='svcmon_csv', vars=vars))}}
          </td>
          <td>
            {{=A(IMG(_src=URL(r=request,c='static',f='viz.png'),_border=0, _title=T("print the topology of the current data cursor")),_href=URL(r=request,f='svcmon_viz', vars=vars))}}
          </td>
          <td>
{{
def option_style(img):
    return 'background-image:url(%s);
            background-repeat:no-repeat;
            padding-left:18px;
           '%URL(r=request,c='static',f=img)
}}

            {{=SPAN(SELECT(
                 OPTION('choose'),
                 OPTION(
                   'stop',
                   _id='stop',
                   _style=option_style('action_stop_16.png'),
                 ),
                 OPTION(
                   'start',
                   _id='start',
                   _style=option_style('action_start_16.png'),
                 ),
                 OPTION(
                   'restart',
                   _id='restart',
                   _style=option_style('action_restart_16.png'),
                 ),
                 OPTION(
                   'syncall',
                   _id='syncall',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncnodes',
                   _id='syncnodes',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncdrp',
                   _id='syncdrp',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncfullsync',
                   _id='syncfullsync',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncresync',
                   _id='syncresync',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncupdate',
                   _id='syncupdate',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncbreak',
                   _id='syncbreak',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'syncswap',
                   _id='syncswap',
                   _style=option_style('action_sync_16.png'),
                 ),
                 OPTION(
                   'push',
                   _id='push',
                   _style=option_style('action16.png'),
                 ),
                 OPTION(
                   'freeze',
                   _id='freeze',
                   _style=option_style('action16.png'),
                 ),
                 OPTION(
                   'thaw',
                   _id='thaw',
                   _style=option_style('action16.png'),
                 ),
                 _name='select_action',
                 _id='select_action',
               ),
               INPUT(
                 _value=T("go"),
                 _name="go",
                 _id="go",
                 _type="submit",
               ),
               )
            }}
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
</form>
